groups:
  - name: elasticsearch rule
    rules:
    - alert: Elasticsearch 堆使用率过高
      expr: (elasticsearch_jvm_memory_used_bytes{area="heap"} / elasticsearch_jvm_memory_max_bytes{area="heap"}) * 100 > 98
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "Elasticsearch 堆使用率过高，超过98% 当前: {{ $value | humanizePercentage  }}%"

    - alert: Elasticsearch 堆使用情况警告
      expr: (elasticsearch_jvm_memory_used_bytes{area="heap"} / elasticsearch_jvm_memory_max_bytes{area="heap"}) * 100 > 95
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "Elasticsearch 堆使用情况警告，超过95%，当前：{{ $value | humanizePercentage  }}%"

    - alert: Elasticsearch 磁盘空间不足
      expr: elasticsearch_filesystem_data_available_bytes / elasticsearch_filesystem_data_size_bytes * 100 < 10
      for: 0m
      labels:
        severity: critical
        channels: "@linux/feishu;"
        level: P0
      annotations:
        summary: "Elasticsearch 磁盘空间不足90%，当前: {{ $value | humanizePercentage  }}"

    - alert: Elasticsearch 集群状态-红expr: elasticsearch_cluster_health_status{color="red"} == 1
      for: 0m
      labels:
        severity: critical
        channels: "@linux/feishu;"
        level: P0
      annotations:
        summary: "Elasticsearch 集群状态 红"

    - alert: Elasticsearch 集群状态-黄
      expr: elasticsearch_cluster_health_status{color="yellow"} == 1
      for: 0m
      labels:
        severity: critical
        channels: "@linux/feishu;"
        level: P0
      annotations:
        summary: "Elasticsearch 集群状态 黄"

    - alert: Elasticsearch 健康节点
      expr: elasticsearch_cluster_health_number_of_nodes < 3
      for: 0m
      labels:
        severity: critical
        channels: "@linux/feishu;"
        level: P0
      annotations:
        summary: "Elasticsearch 健康节点丢失"

    - alert: Elasticsearch 健康数据节点
      expr: elasticsearch_cluster_health_number_of_data_nodes < 3
      for: 0m
      labels:
        severity: critical
        channels: "@linux/feishu;"
        level: P0
      annotations:
        summary: "Elasticsearch 健康数据节点丢失"

    - alert: Elasticsearch 迁移分片
      expr: elasticsearch_cluster_health_relocating_shards > 0
      for: 0m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "Elasticsearch 迁移分片"

    - alert: Elasticsearch 迁移分片时间太长
      expr: elasticsearch_cluster_health_relocating_shards > 0
      for: 15m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "Elasticsearch 迁移分片时间太长"

    - alert: Elasticsearch 初始化分片时间太长
      expr: elasticsearch_cluster_health_initializing_shards > 0
      for: 15m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "Elasticsearch 初始化分片时间太长"

    - alert: Elasticsearch 未分配分片
      expr: elasticsearch_cluster_health_unassigned_shards > 0
      for: 0m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "Elasticsearch 未分配分片"

    - alert: Elasticsearch 挂起的任务
      expr: elasticsearch_cluster_health_number_of_pending_tasks > 0
      for: 15m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "Elasticsearch 挂起的任务"

    - alert: Elasticsearch 无新数据
      expr: increase(elasticsearch_indices_docs{es_data_node="true"}[60m]) < 1
      for: 0m
      labels:
        severity: info
        channels: "@linux/feishu;"
        level: P2
      annotations:
        summary: "Elasticsearch 无新数据"
