groups:
  - name: backuppc rule
    rules:
    - alert: 备份失败
      expr: |
        backuppc_hosts_reason{label='Reason_backup_failed',job='backuppc'} == 1
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "{{ $labels.all }}备份失败"
    - alert: 备份失联
      expr: |
        backuppc_hosts_reason{label='Reason_no_ping',job='backuppc'} == 1
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "{{ $labels.all }}主机备份失联"
    - alert: 备份空间不足
      expr: |
        predict_linear(backuppc_disk_usage{job='backuppc'}[1h], 4 * 3600) >= 98
      for: 2m
      labels:
        severity: critical
        channels: "@linux/feishu;"
        level: P0
      annotations:
        summary: "{{ $labels.instance }} 备份池文件系统磁盘空间不足4h"
    #超过三天未增备
    - alert: 未增备
      expr: |
        time() - backuppc_hosts_incr_age{job='backuppc'} > 86400*3 and backuppc_hosts_disabled == 0
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "{{ $labels.all }}超过3天未增备"
    #超过十五天未全备
    - alert: 未全备
      expr: |
        time() - backuppc_hosts_full_age{job='backuppc'} > 86400*15 and backuppc_hosts_disabled == 0
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "{{ $labels.all }}超过15天未全备"

    - alert: 增备间隔异常
      expr: time() - backuppc_hosts_incr_age > 2*backuppc_hosts_incr_period
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "{{ $labels.all }}超过设定值2倍，检查备份策略配置"

    - alert: 磁盘inode耗尽风险
      expr: backuppc_disk_inode_usage > 80
      for: 2m
      labels:
        severity: critical
        channels: "@linux/feishu;"
        level: P0
      annotations:
        summary: "{{ $labels.instance }}剩余inode不足20%，当前{{ $value }}%"

    - alert: 备份速率异常下降
      expr: backuppc_hosts_full_rate < (avg_over_time(backuppc_hosts_full_rate[24h]) * 0.5)
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "{{ $labels.all }}低于历史平均50%，检查存储性能和带宽"

    - alert: 全备时间过长
      expr: backuppc_hosts_full_duration / 3600 > 12
      for: 2m
      labels:
        severity: warning
        channels: "@linux/feishu;"
        level: P1
      annotations:
        summary: "{{ $labels.all }}超过12h，当前{{ $value | humanize }}h"
